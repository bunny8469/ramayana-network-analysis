import spacy

# Load the transformer-based coreference model
nlp = spacy.load("en_coreference_web_trf")

# Your input text
text = "Although Omniscient lord Narayana knew the means to be employed, when he was requested by the best of devatas he spoke to them softly: \"What strategies should be adopted in the matter of destruction of that evilminded Ravana who is a thorn to the sages?\". When the devatas were thus addressed by the imperishable Visnu, they replied him saying, \"You may assume the form of a human being and slay Ravana in the battle\". \"O destroyer of foes Lord Brahma was very pleased with Ravana's intense penance over a long time Pleased, with the rakshasa Brahma granted a boon to the effect that except from men, there was, for him, no fear of death from any other living beings. Ravana ignored men while seeking the boon. Having obtained the boon from Brahma, Ravana, greed and arrogant went on bringing  destruction to the three worlds. He carried away women by violence. O destroyer of foes his death is possible by men only.\" Having obtained the boon from Brahma, Ravana, greed and arrogant went on bringing  destruction to the three worlds. He carried away women by violence. O destroyer of foes his death is possible by men only.\" Having heard the words of devatas, selfpossessed Visnu chose king Dasaratha as his father. At that time, the brilliant king (Dasaratha), destroyer of enemies, who had no sons was performing a sacrifice for sons. After Visnu had decided (to incarnate) and he was worshipped by devatas and maharshis he disappeared bidding farewell to Brahma. During the sacrifice, there emerged from the sacrificial fire a mighty being with unmatched splendour, his prowess and strength. He wore a black and crimson garment. He had a red face. His voice was similar to the sounds of a drum. He had whiskers of soft and shining tawny hair resembling the mane of a lion He had fine hair on his head. He was endowed with auspicious signs and adorned with splendid divine ornaments. His height resembled a mountain peak. He walked with the strides of a ferocious tiger. Similar to the Sun in radiance, he looked like the crest of a blazing fire. This divine being held like his beloved wife both hands, a large vessel made of gold purified, in fire, covered with a silver lid and filled with payasam (a preparation of rice in milk and sugar). It looked as though it was created  by magic. During the sacrifice, there emerged from the sacrificial fire a mighty being with unmatched splendour, his prowess and strength. He wore a black and crimson garment. He had a red face. His voice was similar to the sounds of a drum. He had whiskers of soft and shining tawny hair resembling the mane of a lion He had fine hair on his head. He was endowed with auspicious signs and adorned with splendid divine ornaments. His height resembled a mountain peak. He walked with the strides of a ferocious tiger. Similar to the Sun in radiance, he looked like the crest of a blazing fire. This divine being held like his beloved wife both hands, a large vessel made of gold purified, in fire, covered with a silver lid and filled with payasam (a preparation of rice in milk and sugar). It looked as though it was created  by magic. During the sacrifice, there emerged from the sacrificial fire a mighty being with unmatched splendour, his prowess and strength. He wore a black and crimson garment. He had a red face. His voice was similar to the sounds of a drum. He had whiskers of soft and shining tawny hair resembling the mane of a lion He had fine hair on his head. He was endowed with auspicious signs and adorned with splendid divine ornaments. His height resembled a mountain peak. He walked with the strides of a ferocious tiger. Similar to the Sun in radiance, he looked like the crest of a blazing fire. This divine being held like his beloved wife both hands, a large vessel made of gold purified, in fire, covered with a silver lid and filled with payasam (a preparation of rice in milk and sugar). It looked as though it was created  by magic. During the sacrifice, there emerged from the sacrificial fire a mighty being with unmatched splendour, his prowess and strength. He wore a black and crimson garment. He had a red face. His voice was similar to the sounds of a drum. He had whiskers of soft and shining tawny hair resembling the mane of a lion He had fine hair on his head. He was endowed with auspicious signs and adorned with splendid divine ornaments. His height resembled a mountain peak. He walked with the strides of a ferocious tiger. Similar to the Sun in radiance, he looked like the crest of a blazing fire. This divine being held like his beloved wife both hands, a large vessel made of gold purified, in fire, covered with a silver lid and filled with payasam (a preparation of rice in milk and sugar). It looked as though it was created  by magic. During the sacrifice, there emerged from the sacrificial fire a mighty being with unmatched splendour, his prowess and strength. He wore a black and crimson garment. He had a red face. His voice was similar to the sounds of a drum. He had whiskers of soft and shining tawny hair resembling the mane of a lion He had fine hair on his head. He was endowed with auspicious signs and adorned with splendid divine ornaments. His height resembled a mountain peak. He walked with the strides of a ferocious tiger. Similar to the Sun in radiance, he looked like the crest of a blazing fire. This divine being held like his beloved wife both hands, a large vessel made of gold purified, in fire, covered with a silver lid and filled with payasam (a preparation of rice in milk and sugar). It looked as though it was created  by magic. Having seen king Dasaratha, he said, \"O King you know I have been sent by Prjapati (Brahma), and I am here\". With folded palms the king replied, \"O revered lord. Welcome to you. What can I do for you?\". Thereafter the one who came from Prajapati answered, \"O King you have obtained this payasam today in return for the worship offered to the devatas\". \"O Lion among kings, receive this payasam prepared by gods, conferring progeny, bestowing affluence and improving health. O King you are performing this sacrifice for the sake of sons. Give this to your  worthy consorts to consume it. They will bear you sons\". Dasaratha was pleased to receive respectfully the golden vessel filled with the payasam  prepared and bestowed by devatas. Overwhelmed with great joy, he, walked around that wonderful being of pleasant  countenance again and again and saluated him respectfully. Dasaratha who received the payasam prepared by devatas was highly pleased like a poor man who received wealth. Then that effulgent figure of wonderful form having given the bowl of payasam vanished from there. The inner apartment, brightened with rays of happiness, shone like the autumnal sky in the glow of the moon. He entered the inner apartment and addressing queen Kausalya said, \"Receive this payasam which has the power to give you sons\". Then Dasaratha gave half the portion of payasam to Kausalya, half of the remaining half to Sumitra, half of the remaining portion (oneeighth of original) to Kaikeyi for the sake of a son. On further thinking, he gave the remaining oneeighth portion to Sumitra. In this manner the king divided and distributed the payasam among his wives separately. Then Dasaratha gave half the portion of payasam to Kausalya, half of the remaining half to Sumitra, half of the remaining portion (oneeighth of original) to Kaikeyi for the sake of a son. On further thinking, he gave the remaining oneeighth portion to Sumitra. In this manner the king divided and distributed the payasam among his wives separately. Then Dasaratha gave half the portion of payasam to Kausalya, half of the remaining half to Sumitra, half of the remaining portion (oneeighth of original) to Kaikeyi for the sake of a son. On further thinking, he gave the remaining oneeighth portion to Sumitra. In this manner the king divided and distributed the payasam among his wives separately. The virtuous wives of the king were exceedingly delighted and felt honoured after receiving the payasam . Then the excellent consorts of the king who glowed like fire and the Sun, having consumed the choicest payasam, became pregnant in a short time. The king now regained his composure of mind on seeing his pregnant wives. He looked delighted like Visnu worshipped by Indra, and hosts of siddhas and rishis.      : Thus ends the sixteenth sarga of Balakanda of the holy Ramayana the first epic composed by sage Valmiki.",

# Process the text
doc = nlp(text)

# Function to resolve references
def resolve_references(doc):
    token_mention_mapper = {}
    for cluster in doc.spans:
        if cluster.startswith("coref_clusters"):
            mentions = list(doc.spans[cluster])
            if not mentions:
                continue
            main = mentions[0].text
            for span in mentions[1:]:
                for token in span:
                    token_mention_mapper[token.i] = main
    output = []
    for i, token in enumerate(doc):
        if i in token_mention_mapper:
            output.append(token_mention_mapper[i])
        else:
            output.append(token.text)
    return " ".join(output)

print(resolve_references(doc))
